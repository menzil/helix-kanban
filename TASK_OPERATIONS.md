# 任务操作功能实现完成

## 已实现的功能

### 1. 创建任务 (`a` 键)
- 打开输入对话框
- 输入任务标题
- 自动在当前选中的列创建任务
- 保存到对应状态目录（`todo/`, `doing/`, `done/`）
- 立即在界面上显示

### 2. 编辑任务 (`e` 键)
- 选中任务后按 `e`
- 对话框自动加载当前任务标题
- 支持汉字等多字节字符编辑
- 修改后自动保存到文件
- 发生错误时自动回滚

### 3. 任务状态移动 (`H` / `L` 键)
- `H` (Shift+h) - 将任务移动到左边列
  - todo → (无效)
  - doing → todo
  - done → doing

- `L` (Shift+l) - 将任务移动到右边列
  - todo → doing
  - doing → done
  - done → (无效)

- 自动移动文件到新的状态目录
- 更新任务状态
- 光标自动跳到新列的第一个任务

### 4. 任务在列内移动 (`J` / `K` 键)
- `J` (Shift+j) - 任务在当前列下移一位
- `K` (Shift+k) - 任务在当前列上移一位
- 通过交换任务在列表中的位置实现
- 光标跟随任务移动

## 键盘快捷键总结

### 任务创建与编辑
| 按键 | 功能 | 说明 |
|-----|------|-----|
| `a` | 创建新任务 | 在当前选中列创建 |
| `e` | 编辑任务标题 | 修改选中任务 |
| `d` | 删除任务 | (TODO) |

### 任务导航
| 按键 | 功能 | 说明 |
|-----|------|-----|
| `j` / `↓` | 下一个任务 | 在当前列内向下 |
| `k` / `↑` | 上一个任务 | 在当前列内向上 |
| `h` / `←` | 上一列 | 切换到左边列 |
| `l` / `→` | 下一列 | 切换到右边列 |

### 任务移动
| 按键 | 功能 | 说明 |
|-----|------|-----|
| `H` (Shift+h) | 移到左列 | 改变任务状态 |
| `L` (Shift+l) | 移到右列 | 改变任务状态 |
| `J` (Shift+j) | 列内下移 | 调整任务顺序 |
| `K` (Shift+k) | 列内上移 | 调整任务顺序 |

## 文件系统集成

### 任务创建流程
1. 获取下一个可用的任务 ID
2. 创建 `Task` 对象
3. 调用 `fs::save_task()` 保存为 Markdown 文件
4. 更新内存中的项目任务列表
5. 界面自动刷新

### 任务编辑流程
1. 通过任务 ID 定位任务
2. 修改任务标题
3. 调用 `fs::save_task()` 更新文件
4. 错误时自动回滚到旧标题

### 任务状态移动流程
1. 通过任务 ID 定位任务
2. 修改任务状态字段
3. 调用 `fs::move_task()` 移动文件到新目录
   - 从 `项目/旧状态/任务ID.md`
   - 到 `项目/新状态/任务ID.md`
4. 更新界面状态
5. 错误时自动回滚

### 文件格式
任务文件格式保持不变（Markdown）：
```markdown
# 任务标题

created: 2025-12-09T10:30:00+08:00
priority: medium

任务描述内容...
```

## 技术实现细节

### 借用检查器处理
使用任务 ID 作为中介，避免同时借用问题：
```rust
// ❌ 错误：同时可变借用
fn get_selected_task_mut(app: &mut App) -> Option<&mut Task> {
    // 无法同时借用 app 的多个字段
}

// ✅ 正确：先获取 ID，再查找
fn get_selected_task_id(app: &App) -> Option<u32> {
    // 只需要不可变借用
}
```

### 错误处理和回滚
所有文件操作都有错误处理和回滚机制：
```rust
let old_value = task.field.clone();
task.field = new_value;

if let Err(e) = save_to_file(task) {
    eprintln!("保存失败: {}", e);
    task.field = old_value; // 回滚
}
```

### 状态同步
内存状态和文件系统状态保持同步：
1. 修改内存中的数据
2. 立即保存到文件
3. 失败时回滚内存数据
4. 界面自动反映当前状态

## 使用示例

### 场景 1：创建并完成一个任务
```
1. 按 Space p o → 选择项目
2. 按 a → 输入 "完成文档编写"
3. 按 Enter → 任务创建在 "待办" 列
4. 按 L → 移动到 "进行中"
5. 按 L → 移动到 "已完成"
```

### 场景 2：编辑任务标题
```
1. 用 j/k 选中任务
2. 按 e → 对话框显示当前标题
3. 修改标题 → "完成详细文档编写"
4. 按 Enter → 保存更改
```

### 场景 3：调整任务优先级
```
1. 在 "待办" 列选中低优先级任务
2. 按 K → 上移任务
3. 按 K → 继续上移
4. 任务现在显示在列表顶部
```

## 测试步骤

```bash
cargo run --release

# 测试任务创建
# 1. 打开项目
# 2. 按 a 创建任务
# 3. 输入 "测试任务"
# 4. 确认任务出现在列表中

# 测试任务编辑
# 1. 选中刚创建的任务
# 2. 按 e 编辑
# 3. 修改标题
# 4. 确认修改生效

# 测试状态移动
# 1. 选中任务
# 2. 按 L 移动到 "进行中"
# 3. 确认任务移动到新列
# 4. 按 H 移回 "待办"

# 测试列内移动
# 1. 创建多个任务
# 2. 选中中间的任务
# 3. 按 K 上移
# 4. 按 J 下移
# 5. 确认任务位置变化
```

## 文件修改列表

- `src/input/keyboard.rs`:402-665
  - 添加 EditTask 命令处理
  - 添加 MoveTaskLeft/Right/Up/Down 命令处理
  - 实现 `get_selected_task()` - 获取选中任务
  - 实现 `get_selected_task_id()` - 获取选中任务 ID
  - 实现 `move_task_to_status()` - 状态移动
  - 实现 `move_task_in_column()` - 列内移动
  - 实现 `create_new_task()` - 创建任务
  - 实现 `update_task_title()` - 更新标题

## 编译状态

✅ 编译成功（16 个警告，0 个错误）

## 待实现功能

1. **任务删除** (`d` 键)
   - 添加确认对话框
   - 调用 `fs::delete_task()`
   - 从内存中移除

2. **任务详细信息**
   - 查看/编辑任务描述
   - 设置/修改优先级
   - 设置截止日期

3. **任务搜索/过滤**
   - 按标题搜索
   - 按优先级过滤
   - 按日期范围过滤

4. **批量操作**
   - 选择多个任务
   - 批量移动
   - 批量删除

5. **撤销/重做**
   - 操作历史记录
   - Ctrl+Z 撤销
   - Ctrl+Y 重做

## 总结

✅ 任务创建功能完整
✅ 任务编辑功能完整
✅ 任务状态移动功能完整
✅ 任务列内移动功能完整
✅ 文件系统集成完整
✅ 错误处理和回滚机制完善
✅ 支持汉字等多字节字符
✅ 所有操作都有键盘快捷键

用户现在可以完整地管理任务的整个生命周期：创建 → 编辑 → 移动状态 → 调整顺序！
